name: "Build and Release APK"

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main
      - dev
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: "Create debug keystore for signing"
        run: |
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      - name: "Build release APK"
        run: ./gradlew assembleRelease --stacktrace

      - name: "Get version name"
        id: version
        run: |
          VERSION_NAME="$(jq -r ".elements[0].versionName" "app/build/outputs/apk/release/output-metadata.json")"
          echo "version=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "Version name: $VERSION_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat "app/build/outputs/apk/release/output-metadata.json" >> "$GITHUB_STEP_SUMMARY"
          echo >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: "Rename APK"
        run: |
          mv app/build/outputs/apk/release/*.apk "app/build/outputs/apk/release/NewPipeScrolling_v${{ steps.version.outputs.version }}.apk"

      - name: "Upload APK as artifact"
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: app/build/outputs/apk/release/*.apk

      - name: "Create Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
          name: NewPipe Scrolling v${{ steps.version.outputs.version }}
          body: |
            ## NewPipe Scrolling v${{ steps.version.outputs.version }}
            
            This is a modified version of NewPipe that can be installed alongside the original app.
            
            ### New Features
            - **Hold to Fast-Forward**: Hold anywhere on the player to increase playback speed to 2x. Release to return to normal speed.
            - New setting in Video & Audio settings to enable/disable this feature.
            
            ### Installation
            1. Download the APK below
            2. Install on your Android device (enable "Install from unknown sources" if needed)
            3. This app will appear as "NewPipe Scrolling" and can coexist with the original NewPipe
          files: app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
